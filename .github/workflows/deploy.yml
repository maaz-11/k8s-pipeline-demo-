name: Build and Deploy to K8s

   on:
     push:
       branches: [ main ]
     workflow_dispatch:

   jobs:
     build-and-deploy:
       runs-on: ubuntu-latest
       
       steps:
       - name: Checkout code
         uses: actions/checkout@v3
       
       - name: Login to Docker Hub
         uses: docker/login-action@v2
         with:
           username: ${{ secrets.DOCKERHUB_USERNAME }}
           password: ${{ secrets.DOCKERHUB_TOKEN }}
       
       - name: Build and push Docker image
         uses: docker/build-push-action@v4
         with:
           context: .
           push: true
           tags: maaz111/k8s-pipeline-demo:${{ github.sha }},maaz111/k8s-pipeline-demo:latest
       
       - name: Deploy to Kubernetes
         uses: tale/kubectl-action@v1
         with:
           base64-kube-config: ${{ secrets.KUBE_CONFIG }}
       
       - name: Update deployment
         run: |
           kubectl set image deployment/k8s-demo-app k8s-demo-app=maaz111/k8s-pipeline-demo:${{ github.sha }} --record
           kubectl rollout status deployment/k8s-demo-app
